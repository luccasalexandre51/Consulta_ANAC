<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Consulta RAB (ANAC) • Matrícula → Excel</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 1040px; }
    h1 { margin: 0 0 8px; }
    .muted { color: #555; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 14px; }
    input, button, a.btn {
      padding: 10px 12px; font-size: 16px; border-radius: 10px;
      border: 1px solid #ccc; background: #fff;
    }
    button { cursor: pointer; }
    a.btn { text-decoration: none; display: inline-block; }
    .status { margin-top: 12px; padding: 10px 12px; border-radius: 10px; background: #f6f6f6; border: 1px solid #e6e6e6; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    td, th { border: 1px solid #e2e2e2; padding: 10px 10px; vertical-align: top; }
    th { text-align: left; background: #fafafa; }
    code { background: #f0f0f0; padding: 2px 6px; border-radius: 6px; }
    .footer { margin-top: 24px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Consulta RAB (ANAC)</h1>
  <div class="muted">Digite a matrícula (ex.: <code>PPXDC</code>), consulte e exporte para Excel.</div>

  <div class="row">
    <input id="marca" placeholder="Matrícula (PPXXX)" autocomplete="off" spellcheck="false" />
    <button id="btn">Consultar</button>
    <a id="xls" class="btn" href="#" style="display:none">Exportar Excel</a>
  </div>

  <div id="status" class="status" style="display:none"></div>
  <div id="out"></div>

  <div class="footer muted">
    Dica: você pode acessar direto a API em <code>/api/aeronave?marca=PPXXX</code> (JSON).
  </div>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const $ = (id) => document.getElementById(id);

    const btn = $("btn");
    if (!btn) return;

    btn.addEventListener("click", async () => {
      const statusEl = $("status");
      const outEl = $("out");
      const xlsEl = $("xls");

      const marca = ($("marca")?.value || "").trim().toUpperCase();

      // sempre mostra a área de status quando houver mensagem
      statusEl.style.display = "block";

      if (!marca) {
        statusEl.textContent = "Digite uma matrícula (ex.: PPXXX)";
        return;
      }

      statusEl.textContent = "Consultando...";
      outEl.innerHTML = "";
      xlsEl.style.display = "none";

      try {
        const r = await fetch(`/api/aeronave?marca=${encodeURIComponent(marca)}`);
        const j = await r.json();

        if (j.error) throw new Error(j.error);

        statusEl.textContent = `OK — ${j.marca}`;

        const rows = Object.entries(j.fields || {})
          .map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`)
          .join("");

        outEl.innerHTML = `
          <table>
            <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
            <tbody>${rows || `<tr><td colspan="2">Nenhum dado encontrado</td></tr>`}</tbody>
          </table>
        `;

        xlsEl.href = `/api/aeronave.xlsx?marca=${encodeURIComponent(marca)}`;
        xlsEl.style.display = "inline-block";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Falhou: " + (e?.message || e);
      }
    });
  });
</script>
</body>
</html>
